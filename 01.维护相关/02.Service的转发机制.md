# Service的转发机制iptables

* 目前kubernetes仍然默认通过iptables对服务流量进行转发，容器网络相对复杂，因此通过一个wordpress服务实例对转发机制进行分析。

## Wordpress Service

```text
[root@k8s01 ~]# kubectl describe svc wordpress-01-svc
Name:                     wordpress-01-svc
Namespace:                default
Labels:                   app=wordpress-01
Annotations:              <none>
Selector:                 app=wordpress-01
Type:                     NodePort
IP:                       10.254.42.62
Port:                     <unset>  80/TCP
TargetPort:               80/TCP
NodePort:                 <unset>  32765/TCP
Endpoints:                10.253.25.4:80,10.253.84.4:80
Session Affinity:         ClientIP
External Traffic Policy:  Cluster
Events:                   <none>
```

* Service IP地址段为10.254.0.0/16，POD IP地址段为10.253.0.0/16；
* 通过kubectl命令，可以看到wordpress-01-svc的cluster ip为10.254.42.62，并且有两个endpoint，分别为10.253.25.4:80和10.253.84.4:80；
* 启用了nodeport 32765提供外部直接访问；
* 通过ClientIP会话保持。

## iptables规则

* 通过iptables-save命令查看iptables规则。

```text
[root@k8s01 ~]# iptables-save
# Generated by iptables-save v1.4.21 on Mon May  7 10:54:07 2018
*filter
:INPUT ACCEPT [3126:615039]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [3057:941986]
:DOCKER - [0:0]
:DOCKER-ISOLATION - [0:0]
:DOCKER-USER - [0:0]
:KUBE-FIREWALL - [0:0]
:KUBE-FORWARD - [0:0]
:KUBE-SERVICES - [0:0]
-A INPUT -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A INPUT -j KUBE-FIREWALL
-A FORWARD -m comment --comment "kubernetes forward rules" -j KUBE-FORWARD
-A FORWARD -j DOCKER-USER
-A FORWARD -j DOCKER-ISOLATION
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -o docker0 -j DOCKER
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT
-A FORWARD -s 10.253.0.0/16 -j ACCEPT
-A FORWARD -d 10.253.0.0/16 -j ACCEPT
-A OUTPUT -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A OUTPUT -j KUBE-FIREWALL
-A DOCKER-ISOLATION -j RETURN
-A DOCKER-USER -j RETURN
-A KUBE-FIREWALL -m comment --comment "kubernetes firewall for dropping marked packets" -m mark --mark 0x8000/0x8000 -j DROP
-A KUBE-FORWARD -m comment --comment "kubernetes forwarding rules" -m mark --mark 0x4000/0x4000 -j ACCEPT
-A KUBE-FORWARD -s 10.253.0.0/16 -m comment --comment "kubernetes forwarding conntrack pod source rule" -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A KUBE-FORWARD -d 10.253.0.0/16 -m comment --comment "kubernetes forwarding conntrack pod destination rule" -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
COMMIT
# Completed on Mon May  7 10:54:07 2018
# Generated by iptables-save v1.4.21 on Mon May  7 10:54:07 2018
*nat
:PREROUTING ACCEPT [20:1200]
:INPUT ACCEPT [20:1200]
:OUTPUT ACCEPT [22:1320]
:POSTROUTING ACCEPT [22:1320]
:DOCKER - [0:0]
:KUBE-FIRE-WALL - [0:0]
:KUBE-MARK-DROP - [0:0]
:KUBE-MARK-MASQ - [0:0]
:KUBE-NODEPORTS - [0:0]
:KUBE-POSTROUTING - [0:0]
:KUBE-SEP-6O64CPVDJXXVN5BC - [0:0]
:KUBE-SEP-75X3CDIS4T3QVXCF - [0:0]
:KUBE-SEP-7PD75JK6EF26C2HK - [0:0]
:KUBE-SEP-BTEQH3WI2APVG5WI - [0:0]
:KUBE-SEP-CTVLE2NAKC2V236E - [0:0]
:KUBE-SEP-EWA2KU77QXDC4MTA - [0:0]
:KUBE-SEP-GTAFP74BZFPH6CQM - [0:0]
:KUBE-SEP-HQN63M3IP5K444F3 - [0:0]
:KUBE-SEP-I7ZLLXO3AGNMS3PQ - [0:0]
:KUBE-SEP-JPBMVEYBMPB4MNF4 - [0:0]
:KUBE-SEP-Q6QA3I2UU4P2TRVC - [0:0]
:KUBE-SEP-R7ITYZ3YDKZ3GBDN - [0:0]
:KUBE-SEP-SFVQ7C4KWYN7BIOU - [0:0]
:KUBE-SEP-USB25RTK4WM5ZHQ3 - [0:0]
:KUBE-SEP-WLG2BGNHX5GEYJ2Y - [0:0]
:KUBE-SEP-XN3I23B6JXDLF55A - [0:0]
:KUBE-SEP-YIOQJBJRYEKBOESG - [0:0]
:KUBE-SERVICES - [0:0]
:KUBE-SVC-4E7KSV2ABIFJRAUZ - [0:0]
:KUBE-SVC-6KCV6CJDHUR5AKHI - [0:0]
:KUBE-SVC-BJM46V3U5RZHCFRZ - [0:0]
:KUBE-SVC-E6QDTEVXMTWFYZ6I - [0:0]
:KUBE-SVC-ERIFXISQEP7F7OF4 - [0:0]
:KUBE-SVC-J4PGGZ6AUXZWNA2B - [0:0]
:KUBE-SVC-JRXTEHDDTAFMSEAS - [0:0]
:KUBE-SVC-NPX46M4PTMTKRN6Y - [0:0]
:KUBE-SVC-Q6XJQ2I55QTBQCWT - [0:0]
:KUBE-SVC-QYS3VDMSAZUOTSWJ - [0:0]
:KUBE-SVC-REQ4FPVT7WYF4VLA - [0:0]
:KUBE-SVC-TCOU7JCQXEZGVUNU - [0:0]
:KUBE-SVC-TQ2QDSSPFS6B64QO - [0:0]
:KUBE-SVC-XGLOHA7QRQ3V22RZ - [0:0]
-A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -m comment --comment "kubernetes postrouting rules" -j KUBE-POSTROUTING
-A POSTROUTING -s 10.253.51.0/24 ! -o docker0 -j MASQUERADE
-A DOCKER -i docker0 -j RETURN
-A KUBE-MARK-DROP -j MARK --set-xmark 0x8000/0x8000
-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000
-A KUBE-NODEPORTS -p tcp -m comment --comment "ingress-nginx/ingress-nginx:http" -m tcp --dport 30080 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment "ingress-nginx/ingress-nginx:http" -m tcp --dport 30080 -j KUBE-SVC-REQ4FPVT7WYF4VLA
-A KUBE-NODEPORTS -p tcp -m comment --comment "default/wordpress-01-svc:" -m tcp --dport 32765 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment "default/wordpress-01-svc:" -m tcp --dport 32765 -j KUBE-SVC-QYS3VDMSAZUOTSWJ
-A KUBE-NODEPORTS -p tcp -m comment --comment "ingress-nginx/ingress-nginx:https" -m tcp --dport 30443 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment "ingress-nginx/ingress-nginx:https" -m tcp --dport 30443 -j KUBE-SVC-4E7KSV2ABIFJRAUZ
-A KUBE-NODEPORTS -p tcp -m comment --comment "kube-system/kubernetes-dashboard:" -m tcp --dport 32767 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment "kube-system/kubernetes-dashboard:" -m tcp --dport 32767 -j KUBE-SVC-XGLOHA7QRQ3V22RZ
-A KUBE-NODEPORTS -p tcp -m comment --comment "kube-system/monitoring-grafana:" -m tcp --dport 32766 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment "kube-system/monitoring-grafana:" -m tcp --dport 32766 -j KUBE-SVC-JRXTEHDDTAFMSEAS
-A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -m mark --mark 0x4000/0x4000 -j MASQUERADE
-A KUBE-SEP-6O64CPVDJXXVN5BC -s 172.16.1.11/32 -m comment --comment "default/heketi-storage-endpoints:" -j KUBE-MARK-MASQ
-A KUBE-SEP-6O64CPVDJXXVN5BC -p tcp -m comment --comment "default/heketi-storage-endpoints:" -m tcp -j DNAT --to-destination 172.16.1.11:1
-A KUBE-SEP-75X3CDIS4T3QVXCF -s 10.253.51.3/32 -m comment --comment "kube-system/monitoring-grafana:" -j KUBE-MARK-MASQ
-A KUBE-SEP-75X3CDIS4T3QVXCF -p tcp -m comment --comment "kube-system/monitoring-grafana:" -m tcp -j DNAT --to-destination 10.253.51.3:3000
-A KUBE-SEP-7PD75JK6EF26C2HK -s 10.253.84.3/32 -m comment --comment "default/heketi:heketi" -j KUBE-MARK-MASQ
-A KUBE-SEP-7PD75JK6EF26C2HK -p tcp -m comment --comment "default/heketi:heketi" -m tcp -j DNAT --to-destination 10.253.84.3:8080
-A KUBE-SEP-BTEQH3WI2APVG5WI -s 10.253.84.2/32 -m comment --comment "kube-system/kube-dns:dns-tcp" -j KUBE-MARK-MASQ
-A KUBE-SEP-BTEQH3WI2APVG5WI -p tcp -m comment --comment "kube-system/kube-dns:dns-tcp" -m tcp -j DNAT --to-destination 10.253.84.2:53
-A KUBE-SEP-CTVLE2NAKC2V236E -s 10.253.84.2/32 -m comment --comment "kube-system/kube-dns:dns" -j KUBE-MARK-MASQ
-A KUBE-SEP-CTVLE2NAKC2V236E -p udp -m comment --comment "kube-system/kube-dns:dns" -m udp -j DNAT --to-destination 10.253.84.2:53
-A KUBE-SEP-EWA2KU77QXDC4MTA -s 172.16.1.10/32 -m comment --comment "default/kubernetes:https" -j KUBE-MARK-MASQ
-A KUBE-SEP-EWA2KU77QXDC4MTA -p tcp -m comment --comment "default/kubernetes:https" -m recent --set --name KUBE-SEP-EWA2KU77QXDC4MTA --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 172.16.1.10:6443
-A KUBE-SEP-GTAFP74BZFPH6CQM -s 172.16.1.10/32 -m comment --comment "default/heketi-storage-endpoints:" -j KUBE-MARK-MASQ
-A KUBE-SEP-GTAFP74BZFPH6CQM -p tcp -m comment --comment "default/heketi-storage-endpoints:" -m tcp -j DNAT --to-destination 172.16.1.10:1
-A KUBE-SEP-HQN63M3IP5K444F3 -s 10.253.51.2/32 -m comment --comment "kube-system/heapster:" -j KUBE-MARK-MASQ
-A KUBE-SEP-HQN63M3IP5K444F3 -p tcp -m comment --comment "kube-system/heapster:" -m tcp -j DNAT --to-destination 10.253.51.2:8082
-A KUBE-SEP-I7ZLLXO3AGNMS3PQ -s 10.253.84.4/32 -m comment --comment "default/wordpress-01-svc:" -j KUBE-MARK-MASQ
-A KUBE-SEP-I7ZLLXO3AGNMS3PQ -p tcp -m comment --comment "default/wordpress-01-svc:" -m recent --set --name KUBE-SEP-I7ZLLXO3AGNMS3PQ --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.253.84.4:80
-A KUBE-SEP-JPBMVEYBMPB4MNF4 -s 10.253.25.3/32 -m comment --comment "ingress-nginx/default-http-backend:" -j KUBE-MARK-MASQ
-A KUBE-SEP-JPBMVEYBMPB4MNF4 -p tcp -m comment --comment "ingress-nginx/default-http-backend:" -m tcp -j DNAT --to-destination 10.253.25.3:8080
-A KUBE-SEP-Q6QA3I2UU4P2TRVC -s 10.253.25.4/32 -m comment --comment "default/wordpress-01-svc:" -j KUBE-MARK-MASQ
-A KUBE-SEP-Q6QA3I2UU4P2TRVC -p tcp -m comment --comment "default/wordpress-01-svc:" -m recent --set --name KUBE-SEP-Q6QA3I2UU4P2TRVC --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.253.25.4:80
-A KUBE-SEP-R7ITYZ3YDKZ3GBDN -s 10.253.25.2/32 -m comment --comment "ingress-nginx/ingress-nginx:https" -j KUBE-MARK-MASQ
-A KUBE-SEP-R7ITYZ3YDKZ3GBDN -p tcp -m comment --comment "ingress-nginx/ingress-nginx:https" -m tcp -j DNAT --to-destination 10.253.25.2:443
-A KUBE-SEP-SFVQ7C4KWYN7BIOU -s 10.253.25.5/32 -m comment --comment "default/mysql-01-svc:" -j KUBE-MARK-MASQ
-A KUBE-SEP-SFVQ7C4KWYN7BIOU -p tcp -m comment --comment "default/mysql-01-svc:" -m tcp -j DNAT --to-destination 10.253.25.5:3306
-A KUBE-SEP-USB25RTK4WM5ZHQ3 -s 10.253.51.4/32 -m comment --comment "kube-system/monitoring-influxdb:" -j KUBE-MARK-MASQ
-A KUBE-SEP-USB25RTK4WM5ZHQ3 -p tcp -m comment --comment "kube-system/monitoring-influxdb:" -m tcp -j DNAT --to-destination 10.253.51.4:8086
-A KUBE-SEP-WLG2BGNHX5GEYJ2Y -s 10.253.25.2/32 -m comment --comment "ingress-nginx/ingress-nginx:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-WLG2BGNHX5GEYJ2Y -p tcp -m comment --comment "ingress-nginx/ingress-nginx:http" -m tcp -j DNAT --to-destination 10.253.25.2:80
-A KUBE-SEP-XN3I23B6JXDLF55A -s 172.16.1.12/32 -m comment --comment "default/heketi-storage-endpoints:" -j KUBE-MARK-MASQ
-A KUBE-SEP-XN3I23B6JXDLF55A -p tcp -m comment --comment "default/heketi-storage-endpoints:" -m tcp -j DNAT --to-destination 172.16.1.12:1
-A KUBE-SEP-YIOQJBJRYEKBOESG -s 10.253.51.5/32 -m comment --comment "kube-system/kubernetes-dashboard:" -j KUBE-MARK-MASQ
-A KUBE-SEP-YIOQJBJRYEKBOESG -p tcp -m comment --comment "kube-system/kubernetes-dashboard:" -m tcp -j DNAT --to-destination 10.253.51.5:8443
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.112.177/32 -p tcp -m comment --comment "default/heketi-storage-endpoints: cluster IP" -m tcp --dport 1 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.112.177/32 -p tcp -m comment --comment "default/heketi-storage-endpoints: cluster IP" -m tcp --dport 1 -j KUBE-SVC-E6QDTEVXMTWFYZ6I
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.122.20/32 -p tcp -m comment --comment "ingress-nginx/ingress-nginx:http cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.122.20/32 -p tcp -m comment --comment "ingress-nginx/ingress-nginx:http cluster IP" -m tcp --dport 80 -j KUBE-SVC-REQ4FPVT7WYF4VLA
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.0.2/32 -p tcp -m comment --comment "kube-system/kube-dns:dns-tcp cluster IP" -m tcp --dport 53 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.0.2/32 -p tcp -m comment --comment "kube-system/kube-dns:dns-tcp cluster IP" -m tcp --dport 53 -j KUBE-SVC-ERIFXISQEP7F7OF4
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.227.68/32 -p tcp -m comment --comment "kube-system/monitoring-influxdb: cluster IP" -m tcp --dport 8086 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.227.68/32 -p tcp -m comment --comment "kube-system/monitoring-influxdb: cluster IP" -m tcp --dport 8086 -j KUBE-SVC-Q6XJQ2I55QTBQCWT
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.42.62/32 -p tcp -m comment --comment "default/wordpress-01-svc: cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.42.62/32 -p tcp -m comment --comment "default/wordpress-01-svc: cluster IP" -m tcp --dport 80 -j KUBE-SVC-QYS3VDMSAZUOTSWJ
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.0.1/32 -p tcp -m comment --comment "default/kubernetes:https cluster IP" -m tcp --dport 443 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.0.1/32 -p tcp -m comment --comment "default/kubernetes:https cluster IP" -m tcp --dport 443 -j KUBE-SVC-NPX46M4PTMTKRN6Y
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.94.117/32 -p tcp -m comment --comment "ingress-nginx/default-http-backend: cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.94.117/32 -p tcp -m comment --comment "ingress-nginx/default-http-backend: cluster IP" -m tcp --dport 80 -j KUBE-SVC-J4PGGZ6AUXZWNA2B
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.64.95/32 -p tcp -m comment --comment "default/mysql-01-svc: cluster IP" -m tcp --dport 3306 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.64.95/32 -p tcp -m comment --comment "default/mysql-01-svc: cluster IP" -m tcp --dport 3306 -j KUBE-SVC-TQ2QDSSPFS6B64QO
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.122.20/32 -p tcp -m comment --comment "ingress-nginx/ingress-nginx:https cluster IP" -m tcp --dport 443 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.122.20/32 -p tcp -m comment --comment "ingress-nginx/ingress-nginx:https cluster IP" -m tcp --dport 443 -j KUBE-SVC-4E7KSV2ABIFJRAUZ
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.0.2/32 -p udp -m comment --comment "kube-system/kube-dns:dns cluster IP" -m udp --dport 53 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.0.2/32 -p udp -m comment --comment "kube-system/kube-dns:dns cluster IP" -m udp --dport 53 -j KUBE-SVC-TCOU7JCQXEZGVUNU
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.174.122/32 -p tcp -m comment --comment "kube-system/kubernetes-dashboard: cluster IP" -m tcp --dport 443 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.174.122/32 -p tcp -m comment --comment "kube-system/kubernetes-dashboard: cluster IP" -m tcp --dport 443 -j KUBE-SVC-XGLOHA7QRQ3V22RZ
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.111.142/32 -p tcp -m comment --comment "default/heketi:heketi cluster IP" -m tcp --dport 8080 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.111.142/32 -p tcp -m comment --comment "default/heketi:heketi cluster IP" -m tcp --dport 8080 -j KUBE-SVC-6KCV6CJDHUR5AKHI
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.167.37/32 -p tcp -m comment --comment "kube-system/monitoring-grafana: cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.167.37/32 -p tcp -m comment --comment "kube-system/monitoring-grafana: cluster IP" -m tcp --dport 80 -j KUBE-SVC-JRXTEHDDTAFMSEAS
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.204.85/32 -p tcp -m comment --comment "kube-system/heapster: cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.204.85/32 -p tcp -m comment --comment "kube-system/heapster: cluster IP" -m tcp --dport 80 -j KUBE-SVC-BJM46V3U5RZHCFRZ
-A KUBE-SERVICES -m comment --comment "kubernetes service nodeports; NOTE: this must be the last rule in this chain" -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS
-A KUBE-SVC-4E7KSV2ABIFJRAUZ -m comment --comment "ingress-nginx/ingress-nginx:https" -j KUBE-SEP-R7ITYZ3YDKZ3GBDN
-A KUBE-SVC-6KCV6CJDHUR5AKHI -m comment --comment "default/heketi:heketi" -j KUBE-SEP-7PD75JK6EF26C2HK
-A KUBE-SVC-BJM46V3U5RZHCFRZ -m comment --comment "kube-system/heapster:" -j KUBE-SEP-HQN63M3IP5K444F3
-A KUBE-SVC-E6QDTEVXMTWFYZ6I -m comment --comment "default/heketi-storage-endpoints:" -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-GTAFP74BZFPH6CQM
-A KUBE-SVC-E6QDTEVXMTWFYZ6I -m comment --comment "default/heketi-storage-endpoints:" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-6O64CPVDJXXVN5BC
-A KUBE-SVC-E6QDTEVXMTWFYZ6I -m comment --comment "default/heketi-storage-endpoints:" -j KUBE-SEP-XN3I23B6JXDLF55A
-A KUBE-SVC-ERIFXISQEP7F7OF4 -m comment --comment "kube-system/kube-dns:dns-tcp" -j KUBE-SEP-BTEQH3WI2APVG5WI
-A KUBE-SVC-J4PGGZ6AUXZWNA2B -m comment --comment "ingress-nginx/default-http-backend:" -j KUBE-SEP-JPBMVEYBMPB4MNF4
-A KUBE-SVC-JRXTEHDDTAFMSEAS -m comment --comment "kube-system/monitoring-grafana:" -j KUBE-SEP-75X3CDIS4T3QVXCF
-A KUBE-SVC-NPX46M4PTMTKRN6Y -m comment --comment "default/kubernetes:https" -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-EWA2KU77QXDC4MTA --mask 255.255.255.255 --rsource -j KUBE-SEP-EWA2KU77QXDC4MTA
-A KUBE-SVC-NPX46M4PTMTKRN6Y -m comment --comment "default/kubernetes:https" -j KUBE-SEP-EWA2KU77QXDC4MTA
-A KUBE-SVC-Q6XJQ2I55QTBQCWT -m comment --comment "kube-system/monitoring-influxdb:" -j KUBE-SEP-USB25RTK4WM5ZHQ3
-A KUBE-SVC-QYS3VDMSAZUOTSWJ -m comment --comment "default/wordpress-01-svc:" -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-Q6QA3I2UU4P2TRVC --mask 255.255.255.255 --rsource -j KUBE-SEP-Q6QA3I2UU4P2TRVC
-A KUBE-SVC-QYS3VDMSAZUOTSWJ -m comment --comment "default/wordpress-01-svc:" -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-I7ZLLXO3AGNMS3PQ --mask 255.255.255.255 --rsource -j KUBE-SEP-I7ZLLXO3AGNMS3PQ
-A KUBE-SVC-QYS3VDMSAZUOTSWJ -m comment --comment "default/wordpress-01-svc:" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-Q6QA3I2UU4P2TRVC
-A KUBE-SVC-QYS3VDMSAZUOTSWJ -m comment --comment "default/wordpress-01-svc:" -j KUBE-SEP-I7ZLLXO3AGNMS3PQ
-A KUBE-SVC-REQ4FPVT7WYF4VLA -m comment --comment "ingress-nginx/ingress-nginx:http" -j KUBE-SEP-WLG2BGNHX5GEYJ2Y
-A KUBE-SVC-TCOU7JCQXEZGVUNU -m comment --comment "kube-system/kube-dns:dns" -j KUBE-SEP-CTVLE2NAKC2V236E
-A KUBE-SVC-TQ2QDSSPFS6B64QO -m comment --comment "default/mysql-01-svc:" -j KUBE-SEP-SFVQ7C4KWYN7BIOU
-A KUBE-SVC-XGLOHA7QRQ3V22RZ -m comment --comment "kube-system/kubernetes-dashboard:" -j KUBE-SEP-YIOQJBJRYEKBOESG
COMMIT
# Completed on Mon May  7 10:54:07 2018
```

## iptables nat表相关

* 筛选和wordpress-01-svc的相关规则，规则如下：

```text
-A KUBE-SERVICES ! -s 10.253.0.0/16 -d 10.254.42.62/32 -p tcp -m comment --comment "default/wordpress-01-svc: cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.254.42.62/32 -p tcp -m comment --comment "default/wordpress-01-svc: cluster IP" -m tcp --dport 80 -j KUBE-SVC-QYS3VDMSAZUOTSWJ
```

* KUBE-SERVICES规则链先对流入的原地址为非POD IP进行地址转换；
* 将目的地址为wordpress-01-svc服务Cluster IP，--dport为80的流量跳转到KUBE-SVC-QYS3VDMSAZUOTSWJ规则；
* 这两条规则都针对通过Cluster IP访问服务的情况。

```text
-A KUBE-NODEPORTS -p tcp -m comment --comment "default/wordpress-01-svc:" -m tcp --dport 32765 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment "default/wordpress-01-svc:" -m tcp --dport 32765 -j KUBE-SVC-QYS3VDMSAZUOTSWJ
```

* 和通过Cluster IP访问服务类似，通过32765 NodePort的访问，也进行地址转换；
* 将目的地址端口为32765端口的流量跳转到KUBE-SVC-QYS3VDMSAZUOTSWJ规则，可以看出不管是通过ClusterIP还是NodePort，最终都通过iptables进行转发到endpoint。

```text
-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000
```

* 将需要iptables MASQUERADE的包进行标记，SNAT和DNAT将根据此标记进行。

```text
-A KUBE-SVC-QYS3VDMSAZUOTSWJ -m comment --comment "default/wordpress-01-svc:" -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-Q6QA3I2UU4P2TRVC --mask 255.255.255.255 --rsource -j KUBE-SEP-Q6QA3I2UU4P2TRVC
-A KUBE-SVC-QYS3VDMSAZUOTSWJ -m comment --comment "default/wordpress-01-svc:" -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-I7ZLLXO3AGNMS3PQ --mask 255.255.255.255 --rsource -j KUBE-SEP-I7ZLLXO3AGNMS3PQ
-A KUBE-SVC-QYS3VDMSAZUOTSWJ -m comment --comment "default/wordpress-01-svc:" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-Q6QA3I2UU4P2TRVC
-A KUBE-SVC-QYS3VDMSAZUOTSWJ -m comment --comment "default/wordpress-01-svc:" -j KUBE-SEP-I7ZLLXO3AGNMS3PQ
```

* KUBE-SVC-QYS3VDMSAZUOTSWJ通过recent匹配模块实现Service的会话保持功能；
* 针对新连接，采用--probability概率转发至KUBE-SEP-Q6QA3I2UU4P2TRVC规则链，实现负载均衡。

```text
-A KUBE-SEP-Q6QA3I2UU4P2TRVC -s 10.253.25.4/32 -m comment --comment "default/wordpress-01-svc:" -j KUBE-MARK-MASQ
-A KUBE-SEP-Q6QA3I2UU4P2TRVC -p tcp -m comment --comment "default/wordpress-01-svc:" -m recent --set --name KUBE-SEP-Q6QA3I2UU4P2TRVC --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.253.25.4:80
-A KUBE-SEP-I7ZLLXO3AGNMS3PQ -s 10.253.84.4/32 -m comment --comment "default/wordpress-01-svc:" -j KUBE-MARK-MASQ
-A KUBE-SEP-I7ZLLXO3AGNMS3PQ -p tcp -m comment --comment "default/wordpress-01-svc:" -m recent --set --name KUBE-SEP-I7ZLLXO3AGNMS3PQ --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.253.84.4:80
```

* DNAT并转发至后端endpoint。
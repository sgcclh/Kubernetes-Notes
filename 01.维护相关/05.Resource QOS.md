# Resource QOS

## QOS级别

* QoS级别，Guaranteed(完全可靠)>Burstable(弹性波动，较可靠)>BestEffort(尽力而为)，级别越高，服务优先级越高。

## Guaranteed级别

```bash
[user01@k8s01 ~]$ vi qospod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: qos-demo
  namespace: nsdev
spec:
  containers:
  - name: qos-demo-ctr
    image: nginx
    resources:
      limits:
        memory: "200Mi"
        cpu: "500m"
      requests:
        memory: "200Mi"
        cpu: "500m"
[user01@k8s01 ~]$ kubectl create -f qospod.yaml
[user01@k8s01 ~]$ kubectl describe pod qos-demo
Name:         qos-demo
Namespace:    nsdev
Node:         k8s01/172.16.1.10
Start Time:   Thu, 10 May 2018 21:42:28 +0800
Labels:       <none>
Annotations:  <none>
Status:       Running
IP:           10.253.51.6
Containers:
  qos-demo-ctr:
    Container ID:   docker://89154de8aeab1c514d66aa3d3ff56ad19ab2d7dfee845a053ad68d79796c3ae8
    Image:          nginx
    Image ID:       docker-pullable://nginx@sha256:0fb320e2a1b1620b4905facb3447e3d84ad36da0b2c8aa8fe3a5a81d1187b884
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 10 May 2018 21:44:25 +0800
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  200Mi
    Requests:
      cpu:        500m
      memory:     200Mi
    Environment:  <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-sgmbn (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-sgmbn:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-sgmbn
    Optional:    false
QoS Class:       Guaranteed
Node-Selectors:  <none>
Tolerations:     <none>
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              4m    default-scheduler  Successfully assigned qos-demo to k8s01
  Normal  SuccessfulMountVolume  4m    kubelet, k8s01     MountVolume.SetUp succeeded for volume "default-token-sgmbn"
  Normal  Pulling                4m    kubelet, k8s01     pulling image "nginx"
  Normal  Pulled                 2m    kubelet, k8s01     Successfully pulled image "nginx"
  Normal  Created                2m    kubelet, k8s01     Created container
  Normal  Started                2m    kubelet, k8s01     Started container
```

* cpu和memory requests和limits设置相同，创建pod后，将QoS Class设置为Guaranteed；
* 如果cpu和memory 只设置相同的limits，不设置requests，k8s将自动将requests设置为limits值，将QoS Class设置为Guaranteed。

## Burstable级别

```bash
[user01@k8s01 ~]$ vi burstable.yaml
apiVersion: v1
kind: Pod
metadata:
  name: qos-demo-2
  namespace: nsdev
spec:
  containers:
  - name: qos-demo-2-ctr
    image: nginx
    resources:
      limits:
        memory: "200Mi"
      requests:
        memory: "128Mi"
[user01@k8s01 ~]$ kubectl create -f burstable.yaml
[user01@k8s01 ~]$ kubectl describe pod qos-demo-2
Name:         qos-demo-2
Namespace:    nsdev
Node:         k8s03/172.16.1.12
Start Time:   Thu, 10 May 2018 21:59:05 +0800
Labels:       <none>
Annotations:  kubernetes.io/limit-ranger=LimitRanger plugin set: cpu request for container qos-demo-2-ctr; cpu limit for container qos-demo-2-ctr
Status:       Running
IP:           10.253.25.2
Containers:
  qos-demo-2-ctr:
    Container ID:   docker://31bf6a0d2697b9fdee88b65c4d512846bdf47d243bfdb34c022a7583b40f586c
    Image:          nginx
    Image ID:       docker-pullable://nginx@sha256:0fb320e2a1b1620b4905facb3447e3d84ad36da0b2c8aa8fe3a5a81d1187b884
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 10 May 2018 21:59:14 +0800
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  200Mi
    Requests:
      cpu:        100m
      memory:     128Mi
    Environment:  <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-sgmbn (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-sgmbn:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-sgmbn
    Optional:    false
QoS Class:       Burstable
Node-Selectors:  <none>
Tolerations:     <none>
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              1m    default-scheduler  Successfully assigned qos-demo-2 to k8s03
  Normal  SuccessfulMountVolume  1m    kubelet, k8s03     MountVolume.SetUp succeeded for volume "default-token-sgmbn"
  Normal  Pulling                1m    kubelet, k8s03     pulling image "nginx"
  Normal  Pulled                 53s   kubelet, k8s03     Successfully pulled image "nginx"
  Normal  Created                53s   kubelet, k8s03     Created container
  Normal  Started                53s   kubelet, k8s03     Started container
```

* 未达到QoS Class Guaranteed要求，Pod中至少有一个容器设置了requests值。

## BestEfford级别

```bash
[user01@k8s01 ~]$ vi bestefford.yaml
apiVersion: v1
kind: Pod
metadata:
  name: qos-demo-3
  namespace: nsdev
spec:
  containers:
  - name: qos-demo-3-ctr
    image: nginx
[user01@k8s01 ~]$ kubectl config use-context ctx-prod
Switched to context "ctx-prod".
[user01@k8s01 ~]$ kubectl create -f bestefford.yaml
[user01@k8s01 ~]$ kubectl describe pod qos-demo-3
Name:         qos-demo-3
Namespace:    nsprod
Node:         k8s03/172.16.1.12
Start Time:   Thu, 10 May 2018 22:06:43 +0800
Labels:       <none>
Annotations:  <none>
Status:       Running
IP:           10.253.25.2
Containers:
  qos-demo-3-ctr:
    Container ID:   docker://bcd76577afbf509339654ee679538f49902051e119d4fc5197a0a6dc0b5b70d5
    Image:          nginx
    Image ID:       docker-pullable://nginx@sha256:0fb320e2a1b1620b4905facb3447e3d84ad36da0b2c8aa8fe3a5a81d1187b884
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 10 May 2018 22:06:49 +0800
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-69f2h (ro)
Conditions:
  Type           Status
  Initialized    True
  Ready          True
  PodScheduled   True
Volumes:
  default-token-69f2h:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-69f2h
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     <none>
Events:
  Type    Reason                 Age   From               Message
  ----    ------                 ----  ----               -------
  Normal  Scheduled              32s   default-scheduler  Successfully assigned qos-demo-3 to k8s03
  Normal  SuccessfulMountVolume  32s   kubelet, k8s03     MountVolume.SetUp succeeded for volume "default-token-69f2h"
  Normal  Pulling                31s   kubelet, k8s03     pulling image "nginx"
  Normal  Pulled                 26s   kubelet, k8s03     Successfully pulled image "nginx"
  Normal  Created                26s   kubelet, k8s03     Created container
  Normal  Started                26s   kubelet, k8s03     Started container
```

* Bestefford QoS Class要求无任何cpu和memory requests和limits设置；
* 由于nsdev namespace之前设置了limitrange，设置了默认requests和limits值，因此先切换到nsprod namespace的上下文进行创建测试pod。

## QoS工作特性

* 当系统资源不足时，cpu requests无法得到满足，由于CPU为可压缩资源，容器得到的CPU资源会被压缩限流；
* 内存为不可压缩资源，当系统内存不足时，Bestefford级别将优先被杀死，但由于没设置limits值，因此系统空闲时也能获得更多的资源；当系统内存不足时，又无Bestefford级别Pod可杀死，这时Burstable级别Pod将被杀死。一般来说Guaranteed级别Pod优先级最高，一般不会被杀死，但系统确实没有其他优先级更低pod可被杀死释放资源时，Guaranteed级别Pod也可能被杀死。